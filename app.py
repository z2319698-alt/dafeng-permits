import streamlit as st
import pandas as pd
from datetime import datetime

# 1. ç¶²é é«˜ç´šæ„Ÿé…ç½®
st.set_page_config(page_title="å¤§è±è¨±å¯è­‰æ³•è¦ç®¡ç†", layout="wide")

# 2. å®šç¾©æ³•è¦å¤§è…¦
LAW_DATABASE = {
    "ç©ºæ°£æ±¡æŸ“": {
        "å±•å»¶æœŸé™": "æœ‰æ•ˆæœŸé™å±†æ»¿å‰ 3 è‡³ 6 å€‹æœˆå…§",
        "å¿…å‚™å‹•ä½œ": "è‡³ç©ºæ±¡ç³»çµ±æäº¤å±•å»¶ç”³è«‹ï¼Œä¸¦æª¢æŸ¥æ’æ”¾å£ç›£æ¸¬è¨­å‚™æ˜¯å¦éœ€æ ¡æ­£ã€‚",
        "ç•°å‹•è¦å®š": "è£½ç¨‹è¨­å‚™ã€æ“ä½œåƒæ•¸è®Šæ›´å‰ï¼Œæ‡‰é‡æ–°ç”³è«‹è¨­ç½®è¨±å¯ã€‚"
    },
    "æ°´æ±¡æŸ“": {
        "å±•å»¶æœŸé™": "æœ‰æ•ˆæœŸé™å±†æ»¿å‰ 6 å€‹æœˆè‡³ 4 å€‹æœˆå…§",
        "å¿…å‚™å‹•ä½œ": "éœ€å§”è¨—åˆæ ¼æª¢æ¸¬å…¬å¸é€²è¡Œæ”¾æµæ°´æ¡æ¨£ï¼Œä¸¦ä¸Šå‚³æ°´æªè¨ˆç•«ã€‚",
        "ç•°å‹•è¦å®š": "è² è²¬äººè®Šæ›´æ–¼ 30 æ—¥å…§è¾¦ç†ï¼›è£½ç¨‹ç•°å‹•æ‡‰æ–¼äº‹å‰ç”³è«‹ã€‚"
    },
    "å»¢æ£„ç‰©": {
        "å±•å»¶æœŸé™": "ä¾å„åœ°æ–¹ç’°ä¿å±€è¦å®šï¼Œé€šå¸¸ç‚ºå±†æ»¿å‰ 2 è‡³ 3 å€‹æœˆ",
        "å¿…å‚™å‹•ä½œ": "é‡æ–°æ ¸ç®—å»¢æ£„ç‰©ç”¢ç”Ÿé‡ï¼Œæ›´æ–°æ¸…ç†è¨ˆç•«æ›¸ (IWR&MS)ã€‚",
        "ç•°å‹•è¦å®š": "å»¢æ£„ç‰©ç¨®é¡å¢æ¸›éœ€æå‰ç”³è«‹è®Šæ›´ã€‚"
    },
    "æ‡‰å›æ”¶": {
        "å±•å»¶æœŸé™": "å±†æ»¿å‰ 1 å€‹æœˆè¾¦ç†æ›è­‰",
        "å¿…å‚™å‹•ä½œ": "ç¢ºèªå›æ”¶è™•ç†é‡èˆ‡ç”³å ±æ•¸æ“šä¸€è‡´ã€‚",
        "ç•°å‹•è¦å®š": "å» å€æˆ–è¨­å‚™è®Šæ›´éœ€é‡æ–°è¾¦ç†ç™»è¨˜ã€‚"
    }
}

# 3. è®€å–è³‡æ–™
sheet_url = "https://docs.google.com/spreadsheets/d/1BA427GfGw41UWen083KSWxbdRwbe3a1SEF_H89MyBZE/export?format=xlsx"

@st.cache_data(ttl=60)
def load_data():
    df = pd.read_excel(sheet_url, sheet_name='å¤§è±æ—¢æœ‰è¨±å¯è­‰åˆ°æœŸæé†’')
    df['åˆ°æœŸæ—¥æœŸ'] = pd.to_datetime(df['åˆ°æœŸæ—¥æœŸ'], errors='coerce')
    return df

df = load_data()

# 4. ä¸»è¦–è¦ºå€
st.title("ğŸ›¡ï¸ è¨±å¯è­‰è¾¦ç†æŒ‡å¼•ç³»çµ±")
st.markdown("---")

# 5. äº’å‹•å¼æ³•è¦æŸ¥æ‰¾
st.subheader("ğŸ” é¸æ“‡è¨±å¯è­‰ä»¥æŸ¥çœ‹æ³•è¦éœ€æ±‚")
selected_permit = st.selectbox("è«‹é¸æ“‡è¦æŸ¥è©¢çš„è¨±å¯è­‰ï¼š", df['è¨±å¯è­‰åç¨±'].unique())

# æŠ“å–è©²ç­†è³‡æ–™
info = df[df['è¨±å¯è­‰åç¨±'] == selected_permit].iloc[0]
law_name = str(info['é—œè¯æ³•è¦']) 

col1, col2 = st.columns([1, 1.2])

with col1:
    st.info(f"ğŸ“‹ **åŸºæœ¬è³‡è¨Š**\n\n**åˆ°æœŸæ—¥ï¼š** {info['åˆ°æœŸæ—¥æœŸ'].strftime('%Y-%m-%d') if pd.notnull(info['åˆ°æœŸæ—¥æœŸ']) else 'æœªå¡«å¯«'}\n\n**è² è²¬äººï¼š** {info['è² è²¬äººä¿¡ç®±'] if 'è² è²¬äººä¿¡ç®±' in df.columns else 'æœªè¨­å®š'}")

with col2:
    matched_law = None
    for key in LAW_DATABASE:
        if key in law_name:
            matched_law = LAW_DATABASE[key]
            law_title = key
            break
    
    if matched_law:
        st.warning(f"âš–ï¸ **{law_title} ç›¸é—œè¾¦ç†è¦å®š**")
        st.write(f"ğŸ“… **å±•å»¶è¾¦ç†æ™‚é–“ï¼š** {matched_law['å±•å»¶æœŸé™']}")
        st.write(f"ğŸ“ **æ‡‰è¾¦äº‹é …ï¼š** {matched_law['å¿…å‚™å‹•ä½œ']}")
        st.write(f"ğŸ”„ **ç•°å‹•è®Šæ›´æé†’ï¼š** {matched_law['ç•°å‹•è¦å®š']}")
    else:
        st.write("â“ **æ³•è¦è³‡æ–™è£œå……ä¸­**")
        st.caption(f"Excel ç™»è¨˜æ³•è¦ç‚ºï¼š{law_name}")

st.divider()
st.subheader("ğŸ“ å®Œæ•´æ¸…å–®ç¸½è¦½")
# ç¢ºä¿é€™è£¡çš„æ‹¬è™Ÿæ˜¯å®Œæ•´çš„
st.dataframe(df, use_container_width=True)
